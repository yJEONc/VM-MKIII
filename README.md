
# 내신자판기 MKIII (Render 배포용, 서술형 + 최다빈출)

## 1. 개요

- 구글시트 `end` 시트를 기준으로, 학년/학교별 **최신 시험범위 단원**을 읽어옵니다.
- 서버는 캐시 모드(B안)로 동작합니다.
  - 서버 시작 시에만 Google Sheets를 한 번 호출해 end 데이터를 메모리에 저장합니다.
  - 이후에는 캐시에서 빠르게 응답합니다.
- 우측 상단의 **"시험범위 업데이트" 버튼**을 누르면 `/reload`가 호출되어,
  - Google Sheets에서 end 시트를 다시 읽어와 캐시를 갱신합니다.
  - 사실상 "시험범위 데이터만 재시작"하는 효과입니다.
- 단원코드(예: `2-1`, `3-2`)를 이용하여
  - `data/서술형/<학년>/`
  - `data/최다빈출/<학년>/`
  아래의 PDF를 자동으로 찾고, 시험범위에 맞는 PDF를 병합하여 다운로드합니다.

## 2. 폴더 구조

```text
naesin_mkIII_render/
├─ app.py
├─ requirements.txt
├─ Procfile
├─ README.md
│
├─ templates/
│   └─ index.html
├─ static/
│   └─ main.js
└─ data/
    ├─ 서술형/
    │   ├─ 1학년/
    │   ├─ 2학년/
    │   └─ 3학년/
    └─ 최다빈출/
        ├─ 1학년/
        ├─ 2학년/
        └─ 3학년/
```

> `data/서술형`, `data/최다빈출` 폴더 아래에 실제 PDF 파일들을 넣어 사용합니다.

## 3. 구글 시트 & 환경변수 설정

- 스프레드시트 ID: `1rsplfNq4e7d-nrp-Wlg1Mn9dsgjAcNn49yPQDXdzwg8`
- 사용하는 시트 이름: `end`
- end 시트 컬럼 구조 (A1:D1 헤더, A2부터 데이터):

| A(timestamp) | B(grade) | C(school) | D(units)             |
|--------------|----------|-----------|----------------------|
| 2025-12-02   | 1        | 개성중학교 | 2-1,2-2,3-1,3-2 ... |

### GOOGLE_CREDENTIALS 환경변수

Render 대시보드에서:

1. Google Cloud Console에서 서비스 계정 키(JSON)를 발급합니다.
2. JSON 파일 전체 내용을 복사합니다.
3. Render → 해당 서비스 → Environment → Add Environment Variable:
   - KEY: `GOOGLE_CREDENTIALS`
   - VALUE: JSON 전체 내용 (그대로 붙여넣기)

4. 동일한 서비스 계정 이메일을 해당 구글시트에 "보기 권한"으로 공유해야 합니다.

## 4. PDF 파일 네이밍 규칙

- `data/서술형/<학년>/` 예시:
  - `서술형 공략 2-1.생물의 구성(01) 중1.pdf`
- `data/최다빈출/<학년>/` 예시:
  - `최다빈출 공략 2-1.생물의 구성(01) 중1 과학 [25문제] [Q].pdf`

### 단원코드 기반 파일 매칭

- end 시트의 단원코드(예: `2-1`)를 기준으로, 파일명에 `2-1`이 단어 경계로 포함된 PDF를 모두 찾습니다.
- 같은 단원에 대해 `(01), (02)` 등 여러 개가 있으면 모두 병합 순서에 포함됩니다.

### 제목 추출

- 파일명에서 `단원코드.제목(숫자` 패턴에서 `제목` 부분만 추출합니다.
  - 예: `2-1.생물의 구성(01)` → `생물의 구성`
- 서술형/최다빈출 폴더 중 첫 번째로 발견된 파일에서 제목을 추출하고,
  이를 단원 제목으로 사용합니다.
- 해당 단원에 아무 파일도 없으면 `(자료 없음)` 으로 표시되며,
  PDF 병합 시에는 조용히 스킵됩니다. (A안)

## 5. Render 배포 방법 (요약)

1. 이 폴더 구조 그대로 GitHub에 업로드합니다.
2. Render에서 New Web Service → GitHub repo 선택.
3. Build & Run 설정:
   - Build Command: `pip install -r requirements.txt`
   - Start Command: `gunicorn app:app`
4. Environment Variables에 `GOOGLE_CREDENTIALS` 추가 (위 설명 참고).
5. Deploy 후, 서비스 URL로 접속하면 동작합니다.

## 6. 화면/사용 방법

### 사이드바

- **학년 선택** (end 시트에 존재하는 grade 값)
- **학교 선택** (선택한 학년의 학교 목록)

### 메인 화면

1. 선택된 학년/학교 태그 표시
2. end 시트 기준 최신 timestamp 표시
3. **단원 목록 (코드 + 제목)** 표시  
   - 예: `2-1  생물의 구성`
   - 파일이 없는 단원은  
     `1-1  (자료 없음) (서술형/최다빈출 파일 없음)` 으로 표시
4. 아래 버튼:
   - "서술형 생성"
   - "최다빈출 생성"

### 상단 우측 버튼

- `⟳ 시험범위 업데이트`
  - `/reload`를 호출하여 Google Sheets에서 end 데이터를 다시 로드합니다.
  - 성공 시 토스트:
    - "시험범위 데이터가 최신 버전으로 업데이트되었습니다."
  - 이후 학년/학교 선택 상태가 있다면, 자동으로 단원 목록도 새로고침 됩니다.

### PDF 생성 버튼

- "서술형 생성":
  - `data/서술형/<grade>학년/` 아래에서 단원별 PDF를 찾아 병합
- "최다빈출 생성":
  - `data/최다빈출/<grade>학년/` 아래에서 단원별 PDF를 찾아 병합

생성 결과 파일명:

- `<학교명>_<학년>학년_<자료종류>_<YYYYMMDD>.pdf`
- 예: `개성중학교_1학년_서술형_20251204.pdf`

## 7. 에러 처리

- end 캐시에 (학년, 학교) 조합이 없으면: 404 + `{ "error": "not_found" }`
- 병합할 PDF를 하나도 찾지 못하면: 404 + `{ "error": "no_files" }`
  - 프론트에서는 "병합할 PDF 파일을 찾을 수 없습니다." 메시지를 표시
- `/reload` 중 오류가 나면: 500 + `{ "status": "error", "message": ... }`
